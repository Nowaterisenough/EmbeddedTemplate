#!/bin/bash

# Pre-commit hook: 自动格式化代码

# 查找 clang-format 命令
if command -v clang-format >/dev/null 2>&1; then
    CLANG_FORMAT="clang-format"
elif command -v clang-format-18 >/dev/null 2>&1; then
    CLANG_FORMAT="clang-format-18"
elif command -v clang-format-17 >/dev/null 2>&1; then
    CLANG_FORMAT="clang-format-17"
else
    echo "警告: 未找到 clang-format，跳过代码格式化"
    exit 0
fi

# 获取所有待提交的 C/C++ 文件
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h|cpp|hpp)$' | grep -v -E 'STM32Cube|3rd/RTT/RTT')

if [ -z "$FILES" ]; then
    exit 0
fi

echo "正在格式化代码..."

# 格式化每个文件
for FILE in $FILES; do
    if [ -f "$FILE" ]; then
        echo "  格式化: $FILE"
        $CLANG_FORMAT -i --style=file "$FILE"
        git add "$FILE"
    fi
done

echo "代码格式化完成"
exit 0
