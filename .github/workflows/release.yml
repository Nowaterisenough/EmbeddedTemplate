name: Release

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag'
        required: true
        default: 'v1.0.0'

jobs:
  build-all:
    name: Build all board variants
    runs-on: ubuntu-latest

    strategy:
      matrix:
        board: [stm32h743zi, stm32f407zg]
        include:
          - board: stm32h743zi
            preset: h743-gcc-ci
            mcu: STM32H743ZI
          - board: stm32f407zg
            preset: f407-gcc-ci
            mcu: STM32F407ZG

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install ARM GCC toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi
          arm-none-eabi-gcc --version

      - name: Install CMake and Ninja
        run: |
          sudo apt-get install -y cmake ninja-build

      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Configure CMake (Release build)
        run: |
          # 修改 CMakePresets.json 为 Release 构建
          cmake --preset ${{ matrix.preset }} \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build -v

      - name: Display build info
        run: |
          echo "=== Build Information ==="
          echo "Board: ${{ matrix.mcu }}"
          echo "Version: ${{ steps.version.outputs.tag }}"
          echo "Commit: ${{ steps.version.outputs.commit }}"
          echo "Date: ${{ steps.version.outputs.date }}"
          echo ""
          echo "=== Binary Size ==="
          arm-none-eabi-size build/bin/${{ matrix.board }}/EmbeddedTemplate.elf
          echo ""
          echo "=== Files ==="
          ls -lh build/bin/${{ matrix.board }}/

      - name: Create release package
        run: |
          mkdir -p release-package

          # 复制固件文件
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.elf \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.elf
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.bin \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.bin
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.hex \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.hex

          # 创建版本信息文件
          cat > release-package/VERSION.txt <<EOF
          EmbeddedTemplate Firmware
          =========================

          Board: ${{ matrix.mcu }}
          Version: ${{ steps.version.outputs.tag }}
          Build Date: ${{ steps.version.outputs.date }}
          Git Commit: ${{ steps.version.outputs.commit }}
          Toolchain: ARM GCC $(arm-none-eabi-gcc --version | head -n1)

          Files:
          - EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.elf (ELF executable)
          - EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.bin (Raw binary)
          - EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.hex (Intel HEX)
          EOF

          # 打包
          cd release-package
          zip -r ../EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.zip .
          cd ..

          # 生成 SHA256 校验和
          sha256sum EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.zip \
            > EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.zip.sha256

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}-release
          path: |
            EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.zip
            EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.zip.sha256
          retention-days: 90

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.zip
            EmbeddedTemplate-${{ matrix.mcu }}-${{ steps.version.outputs.tag }}.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
