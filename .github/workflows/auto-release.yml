name: Auto Release on Main Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write  # 允许创建 release、tag 和上传文件

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史，用于生成 changelog

      - name: Generate version and tag
        id: version
        run: |
          # 主版本号和次版本号（手动管理）
          MAJOR="01"
          MINOR="00"

          # 构建日期（固定8位：YYYYMMDD）
          BUILD_DATE=$(date +'%Y%m%d')

          # 获取上一个 tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            # 第一次发布，统计所有 commit
            COMMIT_COUNT=$(git rev-list --count HEAD)
          else
            # 统计自上次发布以来的 commit 数量
            COMMIT_COUNT=$(git rev-list --count ${LAST_TAG}..HEAD)
          fi

          # 修订号（固定2位，00-99）
          PATCH=$(printf "%02d" $COMMIT_COUNT)

          # 如果超过99个commit，使用99
          if [ $COMMIT_COUNT -gt 99 ]; then
            PATCH="99"
          fi

          # 生成版本号：01.00.XX.20251029
          TAG="${MAJOR}.${MINOR}.${PATCH}.${BUILD_DATE}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_count=${COMMIT_COUNT}" >> $GITHUB_OUTPUT

          echo "Generated version: ${TAG}"
          echo "Commits since last release: ${COMMIT_COUNT}"

      - name: Create and push tag
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          git push origin "${VERSION}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate changelog and create release
        id: create_release
        run: npx changelogithub --name "Release ${{ steps.version.outputs.tag }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-upload:
    name: Build and Upload ${{ matrix.mcu }}
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: write  # 允许上传文件到 release

    strategy:
      matrix:
        board: [stm32h743zi, stm32f407zg]
        include:
          - board: stm32h743zi
            preset: h743-gcc-ci
            mcu: STM32H743ZI
          - board: stm32f407zg
            preset: f407-gcc-ci
            mcu: STM32F407ZG

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install ARM GCC toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi
          arm-none-eabi-gcc --version

      - name: Install CMake and Ninja
        run: |
          sudo apt-get install -y cmake ninja-build

      - name: Configure CMake (Release build)
        run: |
          cmake --preset ${{ matrix.preset }} -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build -v

      - name: Display build info
        run: |
          echo "=== Build Information ==="
          echo "Board: ${{ matrix.mcu }}"
          echo "Version: ${{ needs.create-release.outputs.tag_name }}"
          echo ""
          echo "=== Binary Size ==="
          arm-none-eabi-size build/bin/${{ matrix.board }}/EmbeddedTemplate.elf

      - name: Create release package
        run: |
          mkdir -p release-package
          TAG="${{ needs.create-release.outputs.tag_name }}"

          # 复制固件文件
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.elf \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.elf
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.bin \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.bin
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.hex \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.hex

          # 创建版本信息文件
          cat > release-package/VERSION.txt <<EOF
          EmbeddedTemplate Firmware
          =========================

          Board: ${{ matrix.mcu }}
          Version: ${TAG}
          Build Date: $(date +'%Y-%m-%d %H:%M:%S UTC')
          Git Commit: $(git rev-parse HEAD)
          Git Short: $(git rev-parse --short HEAD)
          Toolchain: ARM GCC $(arm-none-eabi-gcc --version | head -n1)

          Files:
          - EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.elf (ELF executable with debug symbols)
          - EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.bin (Raw binary for direct flash)
          - EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.hex (Intel HEX format)

          Binary Size:
          $(arm-none-eabi-size build/bin/${{ matrix.board }}/EmbeddedTemplate.elf)
          EOF

          # 打包
          cd release-package
          zip -r ../EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip .
          cd ..

          # 生成 SHA256 校验和
          sha256sum EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip \
            > EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip.sha256

      - name: Upload to Release
        run: |
          TAG="${{ needs.create-release.outputs.tag_name }}"
          gh release upload "${TAG}" \
            EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip \
            EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip.sha256 \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
