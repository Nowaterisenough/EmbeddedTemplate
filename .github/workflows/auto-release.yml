name: Auto Release on Main Push

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # ÊîØÊåÅÊâãÂä®ÊâìtagËß¶Âèë
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Âº∫Âà∂ÂèëÂ∏ÉÔºàÂøΩÁï•commitÁ±ªÂûãÊ£ÄÊü•Ôºâ'
        type: boolean
        default: false

permissions:
  contents: write  # ÂÖÅËÆ∏ÂàõÂª∫ release„ÄÅtag Âíå‰∏ä‰º†Êñá‰ª∂

jobs:
  check-and-version:
    name: Check Release & Generate Version
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      tag_name: ${{ steps.version.outputs.tag }}
      version_type: ${{ steps.check.outputs.version_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ÔºåÁî®‰∫éÁîüÊàê changelog

      - name: Check if should release
        id: check
        run: |
          # ============================================
          # ÈÖçÁΩÆÂå∫ÔºöMAJOR ÁâàÊú¨Âè∑ÔºàÊâãÂä®Áª¥Êä§Ôºâ
          # ============================================
          MAJOR=1

          # ============================================
          # Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•ÂèëÂ∏É
          # ============================================

          # Â¶ÇÊûúÊòØtagÊé®ÈÄÅÔºåÁõ¥Êé•‰ΩøÁî®tag
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=manual_tag" >> $GITHUB_OUTPUT
            echo "üìå Manual tag push detected"
            exit 0
          fi

          # Â¶ÇÊûúÊòØÊâãÂä®Ëß¶Âèë‰∏îÂº∫Âà∂ÂèëÂ∏É
          if [[ "${{ github.event.inputs.force_release }}" == "true" ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=force" >> $GITHUB_OUTPUT
            echo "üî® Force release triggered"
            echo "MAJOR=${MAJOR}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=initial" >> $GITHUB_OUTPUT
            echo "MAJOR=${MAJOR}" >> $GITHUB_OUTPUT
            echo "üéâ First release"
            exit 0
          fi

          # Ëé∑ÂèñËá™‰∏äÊ¨°tag‰ª•Êù•ÁöÑcommits
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s")

          if [ -z "$COMMITS" ]; then
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No new commits since last release"
            exit 0
          fi

          # ÂàÜÊûêcommitÁ±ªÂûã
          HAS_FEAT=false
          HAS_FIX=false
          HAS_BREAKING=false

          while IFS= read -r commit; do
            if [[ "$commit" =~ ^feat(\(.+\))?!?: ]] || [[ "$commit" =~ BREAKING[[:space:]]CHANGE ]]; then
              HAS_BREAKING=true
              HAS_FEAT=true
            elif [[ "$commit" =~ ^feat(\(.+\))?: ]]; then
              HAS_FEAT=true
            elif [[ "$commit" =~ ^fix(\(.+\))?: ]]; then
              HAS_FIX=true
            fi
          done <<< "$COMMITS"

          # ÂÜ≥ÂÆöÁâàÊú¨Á±ªÂûã
          if [ "$HAS_BREAKING" = true ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=major" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  BREAKING CHANGE detected (Âª∫ËÆÆÊâãÂä®ÂçáÁ∫ß MAJOR)"
          elif [ "$HAS_FEAT" = true ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=minor" >> $GITHUB_OUTPUT
            echo "‚ú® New features detected (MINOR bump)"
          elif [ "$HAS_FIX" = true ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_type=patch" >> $GITHUB_OUTPUT
            echo "üêõ Bug fixes detected (PATCH bump)"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No feat/fix commits, skipping release"
            exit 0
          fi

          echo "MAJOR=${MAJOR}" >> $GITHUB_OUTPUT

      - name: Generate version and tag
        if: steps.check.outputs.should_release == 'true'
        id: version
        run: |
          # Â¶ÇÊûúÊòØÊâãÂä®tagÔºåÁõ¥Êé•‰ΩøÁî®
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "Using manual tag: ${TAG}"
            exit 0
          fi

          # ============================================
          # Ëá™Âä®ÁâàÊú¨Âè∑ËÆ°ÁÆó
          # ============================================
          MAJOR=${{ steps.check.outputs.MAJOR }}
          VERSION_TYPE=${{ steps.check.outputs.version_type }}

          # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          # ÁßªÈô§vÂâçÁºÄÂπ∂Ëß£ÊûêÁâàÊú¨Âè∑
          LAST_VERSION=${LAST_TAG#v}
          LAST_MAJOR=$(echo $LAST_VERSION | cut -d. -f1)
          LAST_MINOR=$(echo $LAST_VERSION | cut -d. -f2)
          LAST_PATCH=$(echo $LAST_VERSION | cut -d. -f3)

          # ÂàùÂßãÂåñÊñ∞ÁâàÊú¨Âè∑
          NEW_MAJOR=$MAJOR
          NEW_MINOR=$LAST_MINOR
          NEW_PATCH=$LAST_PATCH

          # Ê£ÄÊü•MAJORÊòØÂê¶ÂèòÂåñ
          if [ "$MAJOR" != "$LAST_MAJOR" ]; then
            NEW_MINOR=0
            NEW_PATCH=0
            echo "üîº MAJOR version changed: ${LAST_MAJOR} -> ${MAJOR}"
          else
            # MAJORÁõ∏ÂêåÔºåÊ†πÊçÆcommitÁ±ªÂûãÂÜ≥ÂÆöMINOR/PATCH
            case $VERSION_TYPE in
              minor)
                NEW_MINOR=$((LAST_MINOR + 1))
                NEW_PATCH=0
                ;;
              patch)
                NEW_PATCH=$((LAST_PATCH + 1))
                ;;
              initial)
                NEW_MINOR=0
                NEW_PATCH=0
                ;;
              force)
                NEW_PATCH=$((LAST_PATCH + 1))
                ;;
            esac
          fi

          # ÁîüÊàêÊúÄÁªàÁâàÊú¨Âè∑
          TAG="v${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "major=${NEW_MAJOR}" >> $GITHUB_OUTPUT
          echo "minor=${NEW_MINOR}" >> $GITHUB_OUTPUT
          echo "patch=${NEW_PATCH}" >> $GITHUB_OUTPUT

          echo "üì¶ Generated version: ${TAG}"
          echo "   Previous: ${LAST_TAG}"
          echo "   Type: ${VERSION_TYPE}"

      - name: Create and push tag
        if: steps.check.outputs.should_release == 'true' && github.ref_type != 'tag'
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          git push origin "${VERSION}"

      - name: Setup Node.js
        if: steps.check.outputs.should_release == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate changelog and create release
        if: steps.check.outputs.should_release == 'true'
        id: create_release
        run: npx changelogithub --name "Release ${{ steps.version.outputs.tag }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-upload:
    name: Build and Upload ${{ matrix.mcu }}
    runs-on: ubuntu-latest
    needs: check-and-version
    if: needs.check-and-version.outputs.should_release == 'true'
    permissions:
      contents: write  # ÂÖÅËÆ∏‰∏ä‰º†Êñá‰ª∂Âà∞ release

    strategy:
      matrix:
        board: [stm32h743zi, stm32f407zg]
        include:
          - board: stm32h743zi
            preset: h743-gcc-ci
            mcu: STM32H743ZI
          - board: stm32f407zg
            preset: f407-gcc-ci
            mcu: STM32F407ZG

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install ARM GCC toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi
          arm-none-eabi-gcc --version

      - name: Install CMake and Ninja
        run: |
          sudo apt-get install -y cmake ninja-build

      - name: Configure CMake (Release build)
        run: |
          cmake --preset ${{ matrix.preset }} -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build -v

      - name: Display build info
        run: |
          echo "=== Build Information ==="
          echo "Board: ${{ matrix.mcu }}"
          echo "Version: ${{ needs.check-and-version.outputs.tag_name }}"
          echo ""
          echo "=== Binary Size ==="
          arm-none-eabi-size build/bin/${{ matrix.board }}/EmbeddedTemplate.elf

      - name: Create release package
        run: |
          mkdir -p release-package
          TAG="${{ needs.check-and-version.outputs.tag_name }}"

          # Â§çÂà∂Âõ∫‰ª∂Êñá‰ª∂
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.elf \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.elf
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.bin \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.bin
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.hex \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.hex

          # ÂàõÂª∫ÁâàÊú¨‰ø°ÊÅØÊñá‰ª∂
          cat > release-package/VERSION.txt <<EOF
          EmbeddedTemplate Firmware
          =========================

          Board: ${{ matrix.mcu }}
          Version: ${TAG}
          Build Date: $(date +'%Y-%m-%d %H:%M:%S UTC')
          Git Commit: $(git rev-parse HEAD)
          Git Short: $(git rev-parse --short HEAD)
          Toolchain: ARM GCC $(arm-none-eabi-gcc --version | head -n1)

          Files:
          - EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.elf (ELF executable with debug symbols)
          - EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.bin (Raw binary for direct flash)
          - EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.hex (Intel HEX format)

          Binary Size:
          $(arm-none-eabi-size build/bin/${{ matrix.board }}/EmbeddedTemplate.elf)
          EOF

          # ÊâìÂåÖ
          cd release-package
          zip -r ../EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip .
          cd ..

          # ÁîüÊàê SHA256 Ê†°È™åÂíå
          sha256sum EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip \
            > EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip.sha256

      - name: Upload to Release
        run: |
          TAG="${{ needs.check-and-version.outputs.tag_name }}"
          gh release upload "${TAG}" \
            EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip \
            EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip.sha256 \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
