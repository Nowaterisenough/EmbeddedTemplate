name: Auto Release on Main Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write  # å…è®¸åˆ›å»º releaseã€tag å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
      tag_name: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽç”Ÿæˆ changelog

      - name: Generate version and tag
        id: version
        run: |
          # ä¸»ç‰ˆæœ¬å·å’Œæ¬¡ç‰ˆæœ¬å·ï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰
          MAJOR="01"
          MINOR="00"

          # æž„å»ºæ—¥æœŸï¼ˆå›ºå®š8ä½ï¼šYYYYMMDDï¼‰
          BUILD_DATE=$(date +'%Y%m%d')

          # èŽ·å–ä¸Šä¸€ä¸ª tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            # ç¬¬ä¸€æ¬¡å‘å¸ƒï¼Œç»Ÿè®¡æ‰€æœ‰ commit
            COMMIT_COUNT=$(git rev-list --count HEAD)
          else
            # ç»Ÿè®¡è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„ commit æ•°é‡
            COMMIT_COUNT=$(git rev-list --count ${LAST_TAG}..HEAD)
          fi

          # ä¿®è®¢å·ï¼ˆå›ºå®š2ä½ï¼Œ00-99ï¼‰
          PATCH=$(printf "%02d" $COMMIT_COUNT)

          # å¦‚æžœè¶…è¿‡99ä¸ªcommitï¼Œä½¿ç”¨99
          if [ $COMMIT_COUNT -gt 99 ]; then
            PATCH="99"
          fi

          # ç”Ÿæˆç‰ˆæœ¬å·ï¼š01.00.XX.20251029
          TAG="${MAJOR}.${MINOR}.${PATCH}.${BUILD_DATE}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_count=${COMMIT_COUNT}" >> $GITHUB_OUTPUT

          echo "Generated version: ${TAG}"
          echo "Commits since last release: ${COMMIT_COUNT}"

      - name: Get last release tag
        id: last_release
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous release found, using first commit"
            LAST_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "last_tag=${LAST_TAG}" >> $GITHUB_OUTPUT
          echo "Last release: ${LAST_TAG}"

      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG="${{ steps.last_release.outputs.last_tag }}"
          VERSION="${{ steps.version.outputs.tag }}"
          COMMIT_COUNT="${{ steps.version.outputs.commit_count }}"

          # ç”Ÿæˆ changelog
          echo "## ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯" > changelog.md
          echo "" >> changelog.md
          echo "- **ç‰ˆæœ¬å·**: ${VERSION}" >> changelog.md
          echo "- **æž„å»ºæ—¥æœŸ**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> changelog.md
          echo "- **æäº¤æ•°é‡**: ${COMMIT_COUNT} ä¸ªæ–°æäº¤" >> changelog.md
          if [ -n "$LAST_TAG" ]; then
            echo "- **ä¸Šä¸€ç‰ˆæœ¬**: ${LAST_TAG}" >> changelog.md
          fi
          echo "" >> changelog.md
          echo "---" >> changelog.md
          echo "" >> changelog.md
          echo "## ðŸ“‹ æ›´æ–°å†…å®¹" >> changelog.md
          echo "" >> changelog.md

          # æŒ‰ç±»åž‹åˆ†ç»„æäº¤
          echo "### âœ¨ æ–°åŠŸèƒ½ (Features)" >> changelog.md
          git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep "^- feat" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md

          echo "### ðŸ› Bug ä¿®å¤ (Fixes)" >> changelog.md
          git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep "^- fix" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md

          echo "### ðŸ”§ é‡æž„ (Refactoring)" >> changelog.md
          git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep "^- refactor" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md

          echo "### ðŸ“ æ–‡æ¡£ (Documentation)" >> changelog.md
          git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep "^- docs" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md

          echo "### ðŸŽ¨ ä»£ç é£Žæ ¼ (Style)" >> changelog.md
          git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep "^- style" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md

          echo "### ðŸ”¨ æž„å»ºç³»ç»Ÿ (Build)" >> changelog.md
          git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep "^- build\|^- ci" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md

          echo "### ðŸ§¹ æ‚é¡¹ (Chores)" >> changelog.md
          git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep "^- chore\|^- perf\|^- test" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md

          echo "### ðŸ“Š å®Œæ•´æäº¤åŽ†å²" >> changelog.md
          echo "" >> changelog.md
          echo "\`\`\`" >> changelog.md
          git log ${LAST_TAG}..HEAD --pretty=format:"%h - %s (%an, %ar)" --no-merges >> changelog.md
          echo "" >> changelog.md
          echo "\`\`\`" >> changelog.md

          cat changelog.md

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: changelog.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-upload:
    name: Build and Upload ${{ matrix.mcu }}
    runs-on: ubuntu-latest
    needs: create-release

    strategy:
      matrix:
        board: [stm32h743zi, stm32f407zg]
        include:
          - board: stm32h743zi
            preset: h743-gcc-ci
            mcu: STM32H743ZI
          - board: stm32f407zg
            preset: f407-gcc-ci
            mcu: STM32F407ZG

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install ARM GCC toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi
          arm-none-eabi-gcc --version

      - name: Install CMake and Ninja
        run: |
          sudo apt-get install -y cmake ninja-build

      - name: Configure CMake (Release build)
        run: |
          cmake --preset ${{ matrix.preset }} -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build -v

      - name: Display build info
        run: |
          echo "=== Build Information ==="
          echo "Board: ${{ matrix.mcu }}"
          echo "Version: ${{ needs.create-release.outputs.tag_name }}"
          echo ""
          echo "=== Binary Size ==="
          arm-none-eabi-size build/bin/${{ matrix.board }}/EmbeddedTemplate.elf

      - name: Create release package
        run: |
          mkdir -p release-package
          TAG="${{ needs.create-release.outputs.tag_name }}"

          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.elf \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.elf
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.bin \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.bin
          cp build/bin/${{ matrix.board }}/EmbeddedTemplate.hex \
             release-package/EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.hex

          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          cat > release-package/VERSION.txt <<EOF
          EmbeddedTemplate Firmware
          =========================

          Board: ${{ matrix.mcu }}
          Version: ${TAG}
          Build Date: $(date +'%Y-%m-%d %H:%M:%S UTC')
          Git Commit: $(git rev-parse HEAD)
          Git Short: $(git rev-parse --short HEAD)
          Toolchain: ARM GCC $(arm-none-eabi-gcc --version | head -n1)

          Files:
          - EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.elf (ELF executable with debug symbols)
          - EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.bin (Raw binary for direct flash)
          - EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.hex (Intel HEX format)

          Binary Size:
          $(arm-none-eabi-size build/bin/${{ matrix.board }}/EmbeddedTemplate.elf)
          EOF

          # æ‰“åŒ…
          cd release-package
          zip -r ../EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip .
          cd ..

          # ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ
          sha256sum EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip \
            > EmbeddedTemplate-${{ matrix.mcu }}-${TAG}.zip.sha256

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-release.outputs.tag_name }}
          files: |
            EmbeddedTemplate-${{ matrix.mcu }}-${{ needs.create-release.outputs.tag_name }}.zip
            EmbeddedTemplate-${{ matrix.mcu }}-${{ needs.create-release.outputs.tag_name }}.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
